<!-- ========== æ­£å®—å°ç‘ªè‰éŠæˆ² ========== -->
<!-- å°‡æ­¤å€å¡ŠåŠ å…¥åˆ°éŠæˆ²å€çš„ flex å®¹å™¨å…§ -->

<div style="text-align:center;">
    <button id="btnMali" class="btn btn-danger" style="margin-bottom:8px;width:360px;font-size:1.1em;">é–‹å§‹ å°ç‘ªè‰</button><br />
    <div id="maliMachine" style="display:none;background:linear-gradient(180deg,#1a0033 0%,#330033 50%,#1a0033 100%);border:5px solid #ffd700;border-radius:20px;padding:15px;width:380px;box-shadow:0 0 40px #ff00ffaa;">

        <!-- æ¨™é¡Œ -->
        <div style="text-align:center;color:#ffd700;font-size:1.8em;font-weight:bold;text-shadow:0 0 15px #ff6b6b;margin-bottom:8px;font-family:Arial;">
            â˜… å°ç‘ªè‰ â˜…
        </div>

        <!-- å½©é‡‘é¡¯ç¤º -->
        <div style="display:flex;justify-content:center;gap:15px;margin-bottom:10px;">
            <div style="background:linear-gradient(180deg,#220000,#440000);border:2px solid #ff0000;border-radius:8px;padding:5px 15px;">
                <div style="color:#ff6666;font-size:0.7em;">BONUS å½©é‡‘</div>
                <div id="maliBonus" style="color:#ff0000;font-size:1.3em;font-weight:bold;text-shadow:0 0 10px #ff0000;">500</div>
            </div>
            <div style="background:linear-gradient(180deg,#002200,#004400);border:2px solid #00ff00;border-radius:8px;padding:5px 15px;">
                <div style="color:#66ff66;font-size:0.7em;">ç›®å‰åˆ†æ•¸</div>
                <div id="maliScore" style="color:#00ff00;font-size:1.3em;font-weight:bold;text-shadow:0 0 10px #00ff00;">1000</div>
            </div>
        </div>

        <!-- è·‘ç‡ˆåœˆåœˆ - ä¸»éŠæˆ²å€ -->
        <div id="maliRing" style="position:relative;width:340px;height:280px;margin:0 auto;background:#000;border-radius:15px;border:3px solid #666;">

            <!-- ä¸Šæ’ -->
            <div class="mali-cell" id="cell0" style="position:absolute;top:5px;left:5px;" data-idx="0">
                <div class="mali-light"></div>
                <div class="mali-icon">ğŸŠ</div>
                <div class="mali-mult">x2</div>
            </div>
            <div class="mali-cell" id="cell1" style="position:absolute;top:5px;left:70px;" data-idx="1">
                <div class="mali-light"></div>
                <div class="mali-icon">ğŸ‹</div>
                <div class="mali-mult">x2</div>
            </div>
            <div class="mali-cell" id="cell2" style="position:absolute;top:5px;left:135px;" data-idx="2">
                <div class="mali-light"></div>
                <div class="mali-icon">ğŸ‰</div>
                <div class="mali-mult">x4</div>
            </div>
            <div class="mali-cell" id="cell3" style="position:absolute;top:5px;left:200px;" data-idx="3">
                <div class="mali-light"></div>
                <div class="mali-icon">â­</div>
                <div class="mali-mult">x100</div>
            </div>
            <div class="mali-cell" id="cell4" style="position:absolute;top:5px;left:265px;" data-idx="4">
                <div class="mali-light"></div>
                <div class="mali-icon">ğŸ‡</div>
                <div class="mali-mult">x3</div>
            </div>

            <!-- å³æ’ -->
            <div class="mali-cell" id="cell5" style="position:absolute;top:70px;left:265px;" data-idx="5">
                <div class="mali-light"></div>
                <div class="mali-icon">ğŸ’</div>
                <div class="mali-mult">x2</div>
            </div>
            <div class="mali-cell" id="cell6" style="position:absolute;top:135px;left:265px;" data-idx="6">
                <div class="mali-light"></div>
                <div class="mali-icon">ğŸ””</div>
                <div class="mali-mult">x6</div>
            </div>
            <div class="mali-cell" id="cell7" style="position:absolute;top:200px;left:265px;" data-idx="7">
                <div class="mali-light"></div>
                <div class="mali-icon">ğŸ°</div>
                <div class="mali-mult">BONUS</div>
            </div>

            <!-- ä¸‹æ’ -->
            <div class="mali-cell" id="cell8" style="position:absolute;top:200px;left:200px;" data-idx="8">
                <div class="mali-light"></div>
                <div class="mali-icon">ğŸŠ</div>
                <div class="mali-mult">x2</div>
            </div>
            <div class="mali-cell" id="cell9" style="position:absolute;top:200px;left:135px;" data-idx="9">
                <div class="mali-light"></div>
                <div class="mali-icon">7ï¸âƒ£</div>
                <div class="mali-mult">x15</div>
            </div>
            <div class="mali-cell" id="cell10" style="position:absolute;top:200px;left:70px;" data-idx="10">
                <div class="mali-light"></div>
                <div class="mali-icon">ğŸ‰</div>
                <div class="mali-mult">x4</div>
            </div>
            <div class="mali-cell" id="cell11" style="position:absolute;top:200px;left:5px;" data-idx="11">
                <div class="mali-light"></div>
                <div class="mali-icon">BAR</div>
                <div class="mali-mult">x10</div>
            </div>

            <!-- å·¦æ’ -->
            <div class="mali-cell" id="cell12" style="position:absolute;top:135px;left:5px;" data-idx="12">
                <div class="mali-light"></div>
                <div class="mali-icon">ğŸ‹</div>
                <div class="mali-mult">x2</div>
            </div>
            <div class="mali-cell" id="cell13" style="position:absolute;top:70px;left:5px;" data-idx="13">
                <div class="mali-light"></div>
                <div class="mali-icon">ğŸ‡</div>
                <div class="mali-mult">x3</div>
            </div>

            <!-- ä¸­é–“é¡¯ç¤ºå€ -->
            <div id="maliCenter" style="position:absolute;top:70px;left:70px;width:195px;height:125px;background:linear-gradient(180deg,#111,#222);border-radius:10px;border:2px solid #444;display:flex;flex-direction:column;justify-content:center;align-items:center;">
                <div id="maliMsg" style="color:#fff;font-size:1em;text-align:center;padding:5px;">æŒ‰ã€Œé–‹å§‹ã€è©¦æ‰‹æ°£ï¼</div>
                <div id="maliWinAmt" style="color:#ffd700;font-size:1.5em;font-weight:bold;text-shadow:0 0 10px #ffd700;"></div>
            </div>
        </div>

        <!-- æŠ¼æ³¨å€ -->
        <div style="margin-top:10px;display:flex;justify-content:center;align-items:center;gap:10px;">
            <span style="color:#fff;">æŠ¼æ³¨ï¼š</span>
            <button id="maliBetDown" class="btn btn-sm btn-secondary">-</button>
            <span id="maliBet" style="color:#ffd700;font-size:1.2em;font-weight:bold;min-width:50px;text-align:center;">10</span>
            <button id="maliBetUp" class="btn btn-sm btn-secondary">+</button>
            <button id="maliBetMax" class="btn btn-sm btn-warning">MAX</button>
        </div>

        <!-- æ“ä½œæŒ‰éˆ• -->
        <div style="margin-top:10px;display:flex;justify-content:center;gap:10px;">
            <button id="maliStart" class="btn btn-success btn-lg" style="font-size:1.2em;font-weight:bold;padding:10px 40px;background:linear-gradient(180deg,#00aa00,#006600);border:2px solid #00ff00;box-shadow:0 0 15px #00ff0066;">
                é–‹ å§‹
            </button>
        </div>

        <!-- æ¯”å¤§å°å€åŸŸ -->
        <div id="maliDouble" style="display:none;margin-top:15px;padding:15px;background:linear-gradient(180deg,#002244,#001133);border-radius:10px;border:2px solid #0088ff;">
            <div style="color:#00aaff;font-size:1em;margin-bottom:8px;">ğŸ² æ¯”å¤§å° - è´äº†ç¿»å€ï¼</div>
            <div style="color:#fff;margin-bottom:5px;">ç›®å‰è´åˆ†ï¼š<span id="maliDoubleAmt" style="color:#ffd700;font-weight:bold;">0</span></div>
            <div style="display:flex;justify-content:center;gap:15px;margin-top:10px;">
                <button id="maliBig" class="btn btn-danger" style="font-size:1.1em;padding:8px 25px;">
                    å¤§ (8-13)
                </button>
                <button id="maliSmall" class="btn btn-primary" style="font-size:1.1em;padding:8px 25px;">
                    å° (1-6)
                </button>
                <button id="maliTake" class="btn btn-warning" style="font-size:1.1em;padding:8px 25px;">
                    æ”¶åˆ†
                </button>
            </div>
            <div id="maliDice" style="font-size:3em;margin-top:10px;min-height:60px;"></div>
            <div id="maliDoubleMsg" style="color:#fff;margin-top:5px;min-height:25px;"></div>
        </div>

        <!-- èªªæ˜ -->
        <div style="margin-top:10px;color:#aaa;font-size:0.7em;">
            æç¤ºï¼šä¸­çå¾Œå¯é¸æ“‡ã€Œæ¯”å¤§å°ã€ç¿»å€ï¼Œæˆ–ç›´æ¥æ”¶åˆ†
        </div>
    </div>
</div>

<style>
.mali-cell {
    width: 60px;
    height: 60px;
    background: linear-gradient(180deg, #222, #111);
    border-radius: 8px;
    border: 2px solid #444;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: relative;
    transition: all 0.1s;
}
.mali-cell.active {
    background: linear-gradient(180deg, #ffff00, #ffaa00) !important;
    border-color: #fff !important;
    box-shadow: 0 0 20px #ffff00, 0 0 40px #ffaa00;
    transform: scale(1.1);
}
.mali-cell.winner {
    animation: mali-flash 0.3s infinite;
}
@keyframes mali-flash {
    0%, 100% { background: linear-gradient(180deg, #ff0000, #aa0000); box-shadow: 0 0 30px #ff0000; }
    50% { background: linear-gradient(180deg, #ffff00, #ffaa00); box-shadow: 0 0 30px #ffff00; }
}
.mali-light {
    position: absolute;
    top: 2px;
    right: 2px;
    width: 8px;
    height: 8px;
    background: #333;
    border-radius: 50%;
    border: 1px solid #555;
}
.mali-cell.active .mali-light {
    background: #ff0000;
    box-shadow: 0 0 5px #ff0000;
}
.mali-icon {
    font-size: 1.5em;
    line-height: 1;
}
.mali-mult {
    font-size: 0.6em;
    color: #ffd700;
    font-weight: bold;
}
.mali-cell.active .mali-mult {
    color: #000;
}
</style>

<!-- ========== å°ç‘ªè‰éŠæˆ² JavaScript ========== -->
<script>
(function() {
    // éŠæˆ²è¨­å®š
    const CELLS = [
        { icon: 'ğŸŠ', name: 'æ©˜å­', mult: 2 },
        { icon: 'ğŸ‹', name: 'æª¸æª¬', mult: 2 },
        { icon: 'ğŸ‰', name: 'è¥¿ç“œ', mult: 4 },
        { icon: 'â­', name: 'æ˜Ÿæ˜Ÿ', mult: 100 },
        { icon: 'ğŸ‡', name: 'è‘¡è„', mult: 3 },
        { icon: 'ğŸ’', name: 'æ«»æ¡ƒ', mult: 2 },
        { icon: 'ğŸ””', name: 'éˆ´éº', mult: 6 },
        { icon: 'ğŸ°', name: 'BONUS', mult: 0, isBonus: true },
        { icon: 'ğŸŠ', name: 'æ©˜å­', mult: 2 },
        { icon: '7ï¸âƒ£', name: 'ä¸ƒä¸ƒ', mult: 15 },
        { icon: 'ğŸ‰', name: 'è¥¿ç“œ', mult: 4 },
        { icon: 'BAR', name: 'BAR', mult: 10 },
        { icon: 'ğŸ‹', name: 'æª¸æª¬', mult: 2 },
        { icon: 'ğŸ‡', name: 'è‘¡è„', mult: 3 }
    ];
    const TOTAL_CELLS = CELLS.length;

    // éŠæˆ²ç‹€æ…‹
    let score = 1000;
    let bonus = 500;
    let bet = 10;
    let currentPos = 0;
    let isRunning = false;
    let winAmount = 0;

    // DOM å…ƒç´ 
    const machine = document.getElementById('maliMachine');
    const scoreDisplay = document.getElementById('maliScore');
    const bonusDisplay = document.getElementById('maliBonus');
    const betDisplay = document.getElementById('maliBet');
    const msgDisplay = document.getElementById('maliMsg');
    const winDisplay = document.getElementById('maliWinAmt');
    const startBtn = document.getElementById('maliStart');
    const doublePanel = document.getElementById('maliDouble');
    const doubleAmtDisplay = document.getElementById('maliDoubleAmt');
    const diceDisplay = document.getElementById('maliDice');
    const doubleMsgDisplay = document.getElementById('maliDoubleMsg');

    // é–‹å§‹éŠæˆ²æŒ‰éˆ•
    document.getElementById('btnMali').onclick = function() {
        machine.style.display = 'block';
        this.style.display = 'none';
    };

    // æŠ¼æ³¨æ§åˆ¶
    document.getElementById('maliBetDown').onclick = () => changeBet(-10);
    document.getElementById('maliBetUp').onclick = () => changeBet(10);
    document.getElementById('maliBetMax').onclick = () => {
        bet = Math.min(500, score);
        betDisplay.innerText = bet;
    };

    function changeBet(amount) {
        bet = Math.max(10, Math.min(bet + amount, score, 500));
        betDisplay.innerText = bet;
    }

    // æ›´æ–°é¡¯ç¤º
    function updateDisplay() {
        scoreDisplay.innerText = score;
        bonusDisplay.innerText = bonus;
        betDisplay.innerText = bet;
    }

    // æ¸…é™¤æ‰€æœ‰ç‡ˆ
    function clearAllLights() {
        for (let i = 0; i < TOTAL_CELLS; i++) {
            document.getElementById('cell' + i).classList.remove('active', 'winner');
        }
    }

    // é»äº®æŒ‡å®šæ ¼å­
    function lightCell(idx) {
        clearAllLights();
        document.getElementById('cell' + idx).classList.add('active');
    }

    // é–‹å§‹æŒ‰éˆ•
    startBtn.onclick = function() {
        if (isRunning) return;
        if (score < bet) {
            msgDisplay.innerText = 'åˆ†æ•¸ä¸è¶³ï¼';
            return;
        }

        // æ‰£åˆ†é–‹å§‹
        isRunning = true;
        score -= bet;
        bonus += Math.floor(bet * 0.1); // 10% é€²å½©é‡‘æ± 
        updateDisplay();
        doublePanel.style.display = 'none';
        winDisplay.innerText = '';
        msgDisplay.innerText = 'è·‘ç‡ˆä¸­...';
        startBtn.disabled = true;

        // æ±ºå®šåœæ­¢ä½ç½® (åŠ æ¬Šéš¨æ©Ÿ)
        const weights = CELLS.map(c => {
            if (c.mult >= 100) return 1;      // æ˜Ÿæ˜Ÿï¼šæ¥µä½æ©Ÿç‡
            if (c.mult >= 15) return 3;       // 77ï¼šä½æ©Ÿç‡
            if (c.isBonus) return 2;          // BONUSï¼šä½æ©Ÿç‡
            if (c.mult >= 10) return 5;       // BARï¼šè¼ƒä½
            if (c.mult >= 6) return 8;        // éˆ´éº
            if (c.mult >= 4) return 12;       // è¥¿ç“œ
            if (c.mult >= 3) return 15;       // è‘¡è„
            return 20;                         // å…¶ä»–
        });
        const totalWeight = weights.reduce((a, b) => a + b, 0);
        let rand = Math.random() * totalWeight;
        let stopPos = 0;
        for (let i = 0; i < weights.length; i++) {
            rand -= weights[i];
            if (rand <= 0) {
                stopPos = i;
                break;
            }
        }

        // è·‘ç‡ˆå‹•ç•«
        let pos = currentPos;
        let speed = 50;
        let rounds = 2 + Math.floor(Math.random() * 2); // è·‘2-3åœˆ
        let totalSteps = rounds * TOTAL_CELLS + ((stopPos - currentPos + TOTAL_CELLS) % TOTAL_CELLS);
        let steps = 0;

        function runLight() {
            lightCell(pos);

            // æ’­æ”¾éŸ³æ•ˆæ„Ÿ (è¦–è¦ºé–ƒçˆ)
            pos = (pos + 1) % TOTAL_CELLS;
            steps++;

            // è¨ˆç®—é€Ÿåº¦ (è¶Šä¾†è¶Šæ…¢)
            const progress = steps / totalSteps;
            if (progress > 0.7) {
                speed = 50 + (progress - 0.7) * 1000; // æœ€å¾Œ30%æ…¢ä¸‹ä¾†
            }

            if (steps < totalSteps) {
                setTimeout(runLight, speed);
            } else {
                // åœæ­¢
                currentPos = stopPos;
                lightCell(stopPos);
                document.getElementById('cell' + stopPos).classList.add('winner');
                onStop(stopPos);
            }
        }

        setTimeout(runLight, speed);
    };

    // åœæ­¢æ™‚çš„è™•ç†
    function onStop(pos) {
        const cell = CELLS[pos];
        isRunning = false;
        startBtn.disabled = false;

        if (cell.isBonus) {
            // ä¸­ BONUS
            winAmount = bonus;
            score += winAmount;
            msgDisplay.innerHTML = 'ğŸ‰ BONUSï¼ğŸ‰';
            winDisplay.innerText = '+' + winAmount;
            bonus = 100; // é‡ç½®å½©é‡‘
            updateDisplay();
            showDoubleOption();
        } else if (cell.mult > 0) {
            // ä¸€èˆ¬ä¸­ç
            winAmount = bet * cell.mult;
            score += winAmount;
            msgDisplay.innerHTML = `ä¸­ ${cell.icon} ${cell.name}ï¼`;
            winDisplay.innerText = '+' + winAmount;
            updateDisplay();
            showDoubleOption();
        } else {
            msgDisplay.innerText = 'æ²’ä¸­ï¼Œå†ä¾†ï¼';
            winAmount = 0;
        }

        // æª¢æŸ¥æ˜¯å¦ç ´ç”¢
        if (score < 10 && winAmount === 0) {
            setTimeout(() => {
                if (confirm('åˆ†æ•¸ä¸è¶³ï¼è¦è£œå…… 1000 åˆ†å—ï¼Ÿ')) {
                    score = 1000;
                    updateDisplay();
                    msgDisplay.innerText = 'å·²è£œå……ï¼ç¹¼çºŒç©ï¼';
                }
            }, 500);
        }

        bet = Math.min(bet, score);
        updateDisplay();
    }

    // é¡¯ç¤ºæ¯”å¤§å°é¸é …
    function showDoubleOption() {
        if (winAmount > 0) {
            doublePanel.style.display = 'block';
            doubleAmtDisplay.innerText = winAmount;
            diceDisplay.innerText = '';
            doubleMsgDisplay.innerText = 'è¦æ¯”å¤§å°å—ï¼ŸçŒœå°ç¿»å€ï¼';
        }
    }

    // æ¯”å¤§å°
    document.getElementById('maliBig').onclick = () => doDouble('big');
    document.getElementById('maliSmall').onclick = () => doDouble('small');
    document.getElementById('maliTake').onclick = takeWin;

    function doDouble(choice) {
        const dice = Math.floor(Math.random() * 13) + 1; // 1-13
        const diceEmojis = ['', '1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ğŸ”Ÿ', 'ğŸ…±ï¸', 'ğŸ…±ï¸', 'ğŸ…±ï¸'];

        // é¡¯ç¤ºéª°å­å‹•ç•«
        let rollCount = 0;
        const rollInterval = setInterval(() => {
            diceDisplay.innerText = diceEmojis[Math.floor(Math.random() * 13) + 1];
            rollCount++;
            if (rollCount >= 10) {
                clearInterval(rollInterval);
                diceDisplay.innerText = dice <= 10 ? diceEmojis[dice] : dice;

                // åˆ¤æ–·çµæœ
                const isSmall = dice >= 1 && dice <= 6;
                const isBig = dice >= 8 && dice <= 13;
                const isTie = dice === 7;

                if (isTie) {
                    doubleMsgDisplay.innerHTML = `<span style="color:#ffff00;">é–‹ 7ï¼å¹³æ‰‹ï¼Œå†ä¾†ä¸€æ¬¡ï¼</span>`;
                } else if ((choice === 'big' && isBig) || (choice === 'small' && isSmall)) {
                    // è´äº†
                    winAmount *= 2;
                    score += winAmount / 2; // è£œä¸Šç¿»å€çš„éƒ¨åˆ†ï¼ˆä¹‹å‰å·²åŠ éä¸€æ¬¡ï¼‰
                    // ä¿®æ­£ï¼šå…ˆæ‰£æ‰åŸæœ¬çš„ï¼Œå†åŠ ç¿»å€å¾Œçš„
                    score = score - winAmount / 2 + winAmount / 2;
                    doubleAmtDisplay.innerText = winAmount;
                    doubleMsgDisplay.innerHTML = `<span style="color:#00ff00;">ğŸ‰ çŒœå°äº†ï¼ç¿»å€ç‚º ${winAmount}ï¼</span>`;
                    updateDisplay();
                } else {
                    // è¼¸äº†
                    score -= winAmount; // æ‰£å›è´çš„åˆ†æ•¸
                    doubleMsgDisplay.innerHTML = `<span style="color:#ff0000;">ğŸ’” çŒœéŒ¯äº†ï¼æå¤± ${winAmount} åˆ†ï¼</span>`;
                    winAmount = 0;
                    updateDisplay();
                    setTimeout(() => {
                        doublePanel.style.display = 'none';
                    }, 1500);
                }

                // å¦‚æœé‚„æœ‰åˆ†å¯ä»¥ç¹¼çºŒæ¯”
                if (winAmount > 0) {
                    doubleAmtDisplay.innerText = winAmount;
                }
            }
        }, 80);
    }

    // æ”¶åˆ†
    function takeWin() {
        doubleMsgDisplay.innerHTML = `<span style="color:#00ff00;">æ”¶ä¸‹ ${winAmount} åˆ†ï¼</span>`;
        winAmount = 0;
        setTimeout(() => {
            doublePanel.style.display = 'none';
        }, 800);
    }

})();
</script>
