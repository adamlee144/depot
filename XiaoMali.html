<!-- ========== æ­£å®—å°ç‘ªè‰éŠæˆ² v3.0 ========== -->
<!-- æ–°å¢ï¼šå†ä¾†ä¸€æ¬¡ã€æ²’æ”¶æ ¼ã€BONUSæ‹‰éœ¸å°éŠæˆ²ã€é€£ç·šåŠ ç¢¼ -->

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å°ç‘ªè‰ æ°´æœæ©Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #1a0033 0%, #330033 50%, #1a0033 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            padding: 10px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        .btn:hover { transform: scale(1.05); }
        .btn:active { transform: scale(0.95); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-success { background: linear-gradient(180deg, #00aa00, #006600); color: #fff; border: 2px solid #00ff00; }
        .btn-danger { background: linear-gradient(180deg, #cc0000, #880000); color: #fff; }
        .btn-warning { background: linear-gradient(180deg, #ffaa00, #cc8800); color: #000; }
        .btn-secondary { background: #555; color: #fff; }
        .btn-primary { background: linear-gradient(180deg, #0066cc, #004488); color: #fff; }
        .btn-sm { padding: 4px 10px; font-size: 0.9em; }

        .mali-cell {
            width: 55px;
            height: 58px;
            background: linear-gradient(180deg, #222, #111);
            border-radius: 8px;
            border: 2px solid #444;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            transition: all 0.1s;
        }
        .mali-cell.active {
            background: linear-gradient(180deg, #ffff00, #ffaa00) !important;
            border-color: #fff !important;
            box-shadow: 0 0 20px #ffff00, 0 0 40px #ffaa00;
            transform: scale(1.1);
            z-index: 10;
        }
        .mali-cell.winner {
            animation: mali-flash 0.3s infinite;
        }
        .mali-cell.has-bet {
            border-color: #00ff00 !important;
            box-shadow: 0 0 10px #00ff0066;
        }
        /* ç‰¹æ®Šæ ¼ï¼šå†ä¾†ä¸€æ¬¡ */
        .mali-cell.special-retry {
            background: linear-gradient(180deg, #004400, #002200) !important;
        }
        .mali-cell.special-retry.active {
            background: linear-gradient(180deg, #00ff00, #00aa00) !important;
        }
        /* ç‰¹æ®Šæ ¼ï¼šæ²’æ”¶ */
        .mali-cell.special-lose {
            background: linear-gradient(180deg, #440000, #220000) !important;
        }
        .mali-cell.special-lose.active {
            background: linear-gradient(180deg, #ff0000, #aa0000) !important;
        }
        @keyframes mali-flash {
            0%, 100% { background: linear-gradient(180deg, #ff0000, #aa0000); box-shadow: 0 0 30px #ff0000; }
            50% { background: linear-gradient(180deg, #ffff00, #ffaa00); box-shadow: 0 0 30px #ffff00; }
        }
        .mali-light {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            background: #333;
            border-radius: 50%;
            border: 1px solid #555;
        }
        .mali-cell.active .mali-light {
            background: #ff0000;
            box-shadow: 0 0 5px #ff0000;
        }
        .mali-icon { font-size: 1.4em; line-height: 1; }
        .mali-mult { font-size: 0.55em; color: #ffd700; font-weight: bold; }
        .mali-cell.active .mali-mult { color: #000; }

        /* æŠ¼æ³¨æ ¼å­æ¨£å¼ */
        .bet-cell {
            background: linear-gradient(180deg, #2a2a2a, #1a1a1a);
            border: 2px solid #444;
            border-radius: 8px;
            padding: 4px 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            min-width: 52px;
        }
        .bet-cell:hover { border-color: #888; transform: scale(1.05); }
        .bet-cell.has-bet {
            border-color: #00ff00;
            background: linear-gradient(180deg, #1a3a1a, #0a2a0a);
            box-shadow: 0 0 10px #00ff0044;
        }
        .bet-cell .bet-icon { font-size: 1.2em; }
        .bet-cell .bet-mult { font-size: 0.6em; color: #aaa; }
        .bet-cell .bet-amount { font-size: 0.85em; color: #00ff00; font-weight: bold; min-height: 16px; }

        /* BONUS æ‹‰éœ¸é®ç½© */
        .slot-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .slot-overlay.active { display: flex; }
        .slot-machine {
            background: linear-gradient(180deg, #2a0a3a, #1a0025);
            border: 5px solid #ffd700;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 0 60px #ff00ff;
        }
        .slot-title {
            color: #ffd700;
            font-size: 1.8em;
            font-weight: bold;
            text-shadow: 0 0 20px #ffd700;
            margin-bottom: 15px;
        }
        .slot-reels {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }
        .slot-reel {
            width: 80px;
            height: 100px;
            background: linear-gradient(180deg, #111, #000);
            border: 3px solid #888;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3em;
            overflow: hidden;
        }
        .slot-reel.spinning {
            animation: slot-blur 0.1s infinite;
        }
        @keyframes slot-blur {
            0%, 100% { filter: blur(0); }
            50% { filter: blur(2px); }
        }
        .slot-reel.winner {
            border-color: #ffd700;
            box-shadow: 0 0 20px #ffd700;
            animation: slot-glow 0.5s infinite;
        }
        @keyframes slot-glow {
            0%, 100% { box-shadow: 0 0 20px #ffd700; }
            50% { box-shadow: 0 0 40px #ff0000; }
        }
        .slot-result {
            color: #fff;
            font-size: 1.3em;
            min-height: 40px;
            margin-bottom: 10px;
        }
        .slot-bonus-amt {
            color: #ffd700;
            font-size: 2em;
            font-weight: bold;
            text-shadow: 0 0 15px #ffd700;
        }
    </style>
</head>
<body>

<div id="maliMachine" style="background:linear-gradient(180deg,#1a0033 0%,#330033 50%,#1a0033 100%);border:5px solid #ffd700;border-radius:20px;padding:15px;box-shadow:0 0 40px #ff00ffaa;display:flex;flex-direction:column;gap:10px;">

    <!-- ========== ä¸Šæ–¹ï¼šè·‘ç‡ˆå€ + æ¯”å¤§å° ========== -->
    <div style="display:flex;gap:15px;justify-content:center;align-items:flex-start;">
        <!-- è·‘ç‡ˆä¸»å€ -->
        <div style="flex-shrink:0;">
            <!-- æ¨™é¡Œ -->
            <div style="text-align:center;color:#ffd700;font-size:1.5em;font-weight:bold;text-shadow:0 0 15px #ff6b6b;margin-bottom:8px;">
                â˜… å°ç‘ªè‰ â˜…
            </div>

            <!-- åˆ†æ•¸é¡¯ç¤º -->
            <div style="display:flex;justify-content:center;gap:8px;margin-bottom:8px;">
                <div style="background:linear-gradient(180deg,#220000,#440000);border:2px solid #ff0000;border-radius:6px;padding:4px 10px;">
                    <div style="color:#ff6666;font-size:0.6em;">BONUS</div>
                    <div id="maliBonus" style="color:#ff0000;font-size:1.1em;font-weight:bold;text-shadow:0 0 10px #ff0000;">500</div>
                </div>
                <div style="background:linear-gradient(180deg,#002200,#004400);border:2px solid #00ff00;border-radius:6px;padding:4px 10px;">
                    <div style="color:#66ff66;font-size:0.6em;">åˆ†æ•¸</div>
                    <div id="maliScore" style="color:#00ff00;font-size:1.1em;font-weight:bold;text-shadow:0 0 10px #00ff00;">1000</div>
                </div>
                <div style="background:linear-gradient(180deg,#222200,#444400);border:2px solid #ffff00;border-radius:6px;padding:4px 10px;">
                    <div style="color:#ffff66;font-size:0.6em;">æŠ¼æ³¨</div>
                    <div id="maliTotalBet" style="color:#ffff00;font-size:1.1em;font-weight:bold;text-shadow:0 0 10px #ffff00;">0</div>
                </div>
            </div>

            <!-- è·‘ç‡ˆåœˆåœˆ (18æ ¼) -->
            <div id="maliRing" style="position:relative;width:445px;height:280px;background:#000;border-radius:12px;border:3px solid #666;">
                <!-- ä¸Šæ’ (7æ ¼) -->
                <div class="mali-cell" id="cell0" style="position:absolute;top:5px;left:5px;" data-fruit="orange">
                    <div class="mali-light"></div><div class="mali-icon">ğŸŠ</div><div class="mali-mult">x5</div>
                </div>
                <div class="mali-cell" id="cell1" style="position:absolute;top:5px;left:68px;" data-fruit="lemon">
                    <div class="mali-light"></div><div class="mali-icon">ğŸ‹</div><div class="mali-mult">x5</div>
                </div>
                <div class="mali-cell" id="cell2" style="position:absolute;top:5px;left:131px;" data-fruit="watermelon">
                    <div class="mali-light"></div><div class="mali-icon">ğŸ‰</div><div class="mali-mult">x10</div>
                </div>
                <div class="mali-cell special-retry" id="cell3" style="position:absolute;top:5px;left:194px;" data-fruit="retry">
                    <div class="mali-light"></div><div class="mali-icon">ğŸ”„</div><div class="mali-mult">å†ä¸€æ¬¡</div>
                </div>
                <div class="mali-cell" id="cell4" style="position:absolute;top:5px;left:257px;" data-fruit="star">
                    <div class="mali-light"></div><div class="mali-icon">â­</div><div class="mali-mult">x50</div>
                </div>
                <div class="mali-cell" id="cell5" style="position:absolute;top:5px;left:320px;" data-fruit="grape">
                    <div class="mali-light"></div><div class="mali-icon">ğŸ‡</div><div class="mali-mult">x8</div>
                </div>
                <div class="mali-cell" id="cell6" style="position:absolute;top:5px;left:383px;" data-fruit="cherry">
                    <div class="mali-light"></div><div class="mali-icon">ğŸ’</div><div class="mali-mult">x5</div>
                </div>
                <!-- å³æ’ (3æ ¼) -->
                <div class="mali-cell" id="cell7" style="position:absolute;top:70px;left:383px;" data-fruit="bell">
                    <div class="mali-light"></div><div class="mali-icon">ğŸ””</div><div class="mali-mult">x15</div>
                </div>
                <div class="mali-cell" id="cell8" style="position:absolute;top:140px;left:383px;" data-fruit="bonus">
                    <div class="mali-light"></div><div class="mali-icon">ğŸ°</div><div class="mali-mult">BONUS</div>
                </div>
                <div class="mali-cell" id="cell9" style="position:absolute;top:210px;left:383px;" data-fruit="orange">
                    <div class="mali-light"></div><div class="mali-icon">ğŸŠ</div><div class="mali-mult">x5</div>
                </div>
                <!-- ä¸‹æ’ (7æ ¼) -->
                <div class="mali-cell" id="cell10" style="position:absolute;top:210px;left:320px;" data-fruit="seven">
                    <div class="mali-light"></div><div class="mali-icon">7ï¸âƒ£</div><div class="mali-mult">x30</div>
                </div>
                <div class="mali-cell special-lose" id="cell11" style="position:absolute;top:210px;left:257px;" data-fruit="lose">
                    <div class="mali-light"></div><div class="mali-icon">ğŸ’€</div><div class="mali-mult">æ²’æ”¶</div>
                </div>
                <div class="mali-cell" id="cell12" style="position:absolute;top:210px;left:194px;" data-fruit="watermelon">
                    <div class="mali-light"></div><div class="mali-icon">ğŸ‰</div><div class="mali-mult">x10</div>
                </div>
                <div class="mali-cell" id="cell13" style="position:absolute;top:210px;left:131px;" data-fruit="bar">
                    <div class="mali-light"></div><div class="mali-icon">BAR</div><div class="mali-mult">x20</div>
                </div>
                <div class="mali-cell" id="cell14" style="position:absolute;top:210px;left:68px;" data-fruit="lemon">
                    <div class="mali-light"></div><div class="mali-icon">ğŸ‹</div><div class="mali-mult">x5</div>
                </div>
                <div class="mali-cell" id="cell15" style="position:absolute;top:210px;left:5px;" data-fruit="grape">
                    <div class="mali-light"></div><div class="mali-icon">ğŸ‡</div><div class="mali-mult">x8</div>
                </div>
                <!-- å·¦æ’ (2æ ¼) -->
                <div class="mali-cell" id="cell16" style="position:absolute;top:140px;left:5px;" data-fruit="cherry">
                    <div class="mali-light"></div><div class="mali-icon">ğŸ’</div><div class="mali-mult">x5</div>
                </div>
                <div class="mali-cell" id="cell17" style="position:absolute;top:70px;left:5px;" data-fruit="apple">
                    <div class="mali-light"></div><div class="mali-icon">ğŸ</div><div class="mali-mult">x8</div>
                </div>
                <!-- ä¸­é–“é¡¯ç¤ºå€ -->
                <div id="maliCenter" style="position:absolute;top:70px;left:68px;width:308px;height:135px;background:linear-gradient(180deg,#111,#222);border-radius:10px;border:2px solid #444;display:flex;flex-direction:column;justify-content:center;align-items:center;">
                    <div id="maliMsg" style="color:#fff;font-size:0.95em;text-align:center;padding:5px;">é¸æ“‡æ°´æœæŠ¼æ³¨<br>æŒ‰ã€Œé–‹å§‹ã€ï¼</div>
                    <div id="maliWinAmt" style="color:#ffd700;font-size:1.6em;font-weight:bold;text-shadow:0 0 10px #ffd700;"></div>
                </div>
            </div>
        </div>

        <!-- æ¯”å¤§å°å€åŸŸï¼ˆå³å´ï¼‰ -->
        <div id="maliDouble" style="display:none;padding:10px;background:linear-gradient(180deg,#002244,#001133);border-radius:10px;border:2px solid #0088ff;min-width:150px;">
            <div style="color:#00aaff;font-size:0.9em;margin-bottom:6px;text-align:center;">ğŸ² æ¯”å¤§å°</div>
            <div style="color:#fff;text-align:center;margin-bottom:6px;">è´åˆ†ï¼š<span id="maliDoubleAmt" style="color:#ffd700;font-weight:bold;font-size:1.2em;">0</span></div>
            <div style="display:flex;flex-direction:column;gap:6px;">
                <button id="maliBig" class="btn btn-danger btn-sm">å¤§(8-13)</button>
                <button id="maliSmall" class="btn btn-primary btn-sm">å°(1-6)</button>
                <button id="maliTake" class="btn btn-warning btn-sm">æ”¶åˆ†</button>
            </div>
            <div id="maliDice" style="font-size:2.5em;margin-top:6px;min-height:45px;text-align:center;"></div>
            <div id="maliDoubleMsg" style="color:#fff;font-size:0.85em;text-align:center;min-height:18px;"></div>
        </div>
    </div>

    <!-- ========== ä¸‹æ–¹ï¼šæŠ¼æ³¨åˆ— + é–‹å§‹æŒ‰éˆ• ========== -->
    <div style="background:linear-gradient(180deg,#111,#1a1a1a);border-radius:10px;border:2px solid #555;padding:10px;">
        <div style="display:flex;align-items:center;gap:10px;">
            <!-- æŠ¼æ³¨æ ¼å­ -->
            <div style="flex:1;">
                <div style="color:#ffd700;font-size:0.7em;text-align:center;margin-bottom:4px;">é»æ“Š +10 / å³éµ -10</div>
                <div id="betPanel" style="display:flex;flex-wrap:nowrap;gap:4px;justify-content:center;">
                    <!-- æŠ¼æ³¨æ ¼å­ç”± JS å‹•æ…‹ç”¢ç”Ÿ -->
                </div>
            </div>
            <!-- æ§åˆ¶æŒ‰éˆ• -->
            <div style="display:flex;flex-direction:column;gap:4px;">
                <div style="display:flex;gap:4px;">
                    <button id="clearBets" class="btn btn-secondary btn-sm" style="font-size:0.75em;padding:3px 8px;">æ¸…é™¤</button>
                    <button id="repeatBet" class="btn btn-warning btn-sm" style="font-size:0.75em;padding:3px 8px;">é‡è¤‡</button>
                    <button id="randomBet" class="btn btn-primary btn-sm" style="font-size:0.75em;padding:3px 8px;">éš¨æ©Ÿ</button>
                </div>
            </div>
            <!-- é–‹å§‹æŒ‰éˆ• -->
            <button id="maliStart" class="btn btn-success" style="padding:12px 25px;font-size:1.2em;box-shadow:0 0 15px #00ff0066;white-space:nowrap;">
                ğŸ° é–‹å§‹
            </button>
        </div>
    </div>

    <!-- èªªæ˜ -->
    <div style="color:#666;font-size:0.6em;text-align:center;line-height:1.3;">
        ğŸ’¡ æŠ¼ä¸­å¾—åˆ† | ğŸ”„å†ä¾†ä¸€æ¬¡ | ğŸ’€æ²’æ”¶æ­¸é›¶ | ğŸ°BONUSæ‹‰éœ¸ é€£ç·šåŠ ç¢¼ï¼
    </div>
</div>

<!-- BONUS æ‹‰éœ¸éŠæˆ² -->
<div id="slotOverlay" class="slot-overlay">
    <div class="slot-machine">
        <div class="slot-title">ğŸ° BONUS æ‹‰éœ¸ ğŸ°</div>
        <div class="slot-reels">
            <div class="slot-reel" id="slotReel0">ğŸ’</div>
            <div class="slot-reel" id="slotReel1">ğŸ’</div>
            <div class="slot-reel" id="slotReel2">ğŸ’</div>
        </div>
        <div class="slot-result" id="slotResult">æ‹‰éœ¸ä¸­...</div>
        <div class="slot-bonus-amt" id="slotBonusAmt"></div>
        <button id="slotClose" class="btn btn-warning" style="margin-top:10px;display:none;">æ”¶ä¸‹çå‹µ</button>
    </div>
</div>

<script>
(function() {
    // ========== éŠæˆ²è¨­å®š ==========
    // RTP ~88% è¨­è¨ˆï¼Œè€ƒæ…®å†ä¾†ä¸€æ¬¡å’Œæ²’æ”¶æ ¼
    const FRUITS = {
        orange:     { icon: 'ğŸŠ', name: 'æ©˜å­', mult: 5,  weight: 85 },
        lemon:      { icon: 'ğŸ‹', name: 'æª¸æª¬', mult: 5,  weight: 85 },
        cherry:     { icon: 'ğŸ’', name: 'æ«»æ¡ƒ', mult: 5,  weight: 85 },
        apple:      { icon: 'ğŸ', name: 'è˜‹æœ', mult: 8,  weight: 110 },
        grape:      { icon: 'ğŸ‡', name: 'è‘¡è„', mult: 8,  weight: 55 },
        watermelon: { icon: 'ğŸ‰', name: 'è¥¿ç“œ', mult: 10, weight: 44 },
        bell:       { icon: 'ğŸ””', name: 'éˆ´éº', mult: 15, weight: 58 },
        bar:        { icon: 'BAR', name: 'BAR', mult: 20, weight: 44 },
        seven:      { icon: '7ï¸âƒ£', name: 'ä¸ƒä¸ƒ', mult: 30, weight: 29 },
        star:       { icon: 'â­', name: 'æ˜Ÿæ˜Ÿ', mult: 50, weight: 18 },
        bonus:      { icon: 'ğŸ°', name: 'BONUS', mult: 0, weight: 12, isBonus: true },
        retry:      { icon: 'ğŸ”„', name: 'å†ä¾†', mult: 0, weight: 35, isRetry: true },
        lose:       { icon: 'ğŸ’€', name: 'æ²’æ”¶', mult: 0, weight: 25, isLose: true }
    };

    // 18æ ¼è·‘ç‡ˆåœˆ
    const CELLS = [
        'orange', 'lemon', 'watermelon', 'retry', 'star', 'grape', 'cherry',
        'bell', 'bonus', 'orange',
        'seven', 'lose', 'watermelon', 'bar', 'lemon', 'grape',
        'cherry', 'apple'
    ];
    const TOTAL_CELLS = CELLS.length;

    // æ‹‰éœ¸æ°´æœï¼ˆç”¨æ–¼BONUSï¼‰
    const SLOT_FRUITS = ['ğŸ’', 'ğŸ‹', 'ğŸŠ', 'ğŸ‡', 'ğŸ‰', 'ğŸ””', 'â­', '7ï¸âƒ£'];

    let score = 1000;
    let bonus = 500;
    let currentPos = 0;
    let isRunning = false;
    let winAmount = 0;
    let bets = {};
    let lastBets = {};
    let pendingRetry = false; // æ˜¯å¦å¾…ã€Œå†ä¾†ä¸€æ¬¡ã€

    // ========== åˆå§‹åŒ–æŠ¼æ³¨é¢æ¿ ==========
    function initBetPanel() {
        const panel = document.getElementById('betPanel');
        const fruitOrder = ['orange', 'lemon', 'cherry', 'apple', 'grape',
                           'watermelon', 'bell', 'bar', 'seven', 'star'];

        fruitOrder.forEach(key => {
            const fruit = FRUITS[key];
            const cell = document.createElement('div');
            cell.className = 'bet-cell';
            cell.dataset.fruit = key;
            cell.innerHTML = `
                <div class="bet-icon">${fruit.icon}</div>
                <div class="bet-mult">x${fruit.mult}</div>
                <div class="bet-amount" id="bet-${key}">-</div>
            `;
            cell.onclick = (e) => { e.preventDefault(); addBet(key, 10); };
            cell.oncontextmenu = (e) => { e.preventDefault(); addBet(key, -10); };
            panel.appendChild(cell);
        });
    }

    function addBet(fruit, amount) {
        if (isRunning) return;
        const currentBet = bets[fruit] || 0;
        const totalOther = Object.entries(bets).reduce((sum, [k, v]) => k !== fruit ? sum + v : sum, 0);

        if (amount > 0) {
            if (totalOther + currentBet + amount > score) {
                showMsg('åˆ†æ•¸ä¸è¶³ï¼');
                return;
            }
            bets[fruit] = currentBet + amount;
        } else {
            bets[fruit] = Math.max(0, currentBet + amount);
            if (bets[fruit] === 0) delete bets[fruit];
        }
        updateBetDisplay();
    }

    function updateBetDisplay() {
        Object.keys(FRUITS).forEach(key => {
            const el = document.getElementById('bet-' + key);
            const cell = el?.parentElement;
            if (el) {
                const amt = bets[key] || 0;
                el.textContent = amt > 0 ? amt : '-';
                if (cell) cell.classList.toggle('has-bet', amt > 0);
            }
        });
        const total = Object.values(bets).reduce((a, b) => a + b, 0);
        document.getElementById('maliTotalBet').textContent = total;

        for (let i = 0; i < TOTAL_CELLS; i++) {
            const cellEl = document.getElementById('cell' + i);
            const fruit = CELLS[i];
            if (FRUITS[fruit] && !FRUITS[fruit].isRetry && !FRUITS[fruit].isLose && !FRUITS[fruit].isBonus) {
                cellEl.classList.toggle('has-bet', (bets[fruit] || 0) > 0);
            }
        }
    }

    document.getElementById('clearBets').onclick = () => {
        if (isRunning) return;
        bets = {};
        updateBetDisplay();
    };

    document.getElementById('repeatBet').onclick = () => {
        if (isRunning) return;
        const totalLast = Object.values(lastBets).reduce((a, b) => a + b, 0);
        if (totalLast === 0) { showMsg('æ²’æœ‰è¨˜éŒ„ï¼'); return; }
        if (totalLast > score) { showMsg('åˆ†æ•¸ä¸è¶³ï¼'); return; }
        bets = { ...lastBets };
        updateBetDisplay();
    };

    document.getElementById('randomBet').onclick = () => {
        if (isRunning) return;
        if (score < 100) { showMsg('åˆ†æ•¸ä¸è¶³ï¼'); return; }
        bets = {};
        const fruitKeys = Object.keys(FRUITS).filter(k =>
            !FRUITS[k].isBonus && !FRUITS[k].isRetry && !FRUITS[k].isLose);
        let remaining = 100;
        const count = 3 + Math.floor(Math.random() * 3);
        const selected = [];
        while (selected.length < count) {
            const f = fruitKeys[Math.floor(Math.random() * fruitKeys.length)];
            if (!selected.includes(f)) selected.push(f);
        }
        selected.forEach((f, i) => {
            if (i === selected.length - 1) {
                bets[f] = remaining;
            } else {
                const amt = Math.floor(Math.random() * (remaining / 2)) + 10;
                bets[f] = Math.floor(amt / 10) * 10;
                remaining -= bets[f];
            }
        });
        updateBetDisplay();
    };

    // ========== DOM ==========
    const scoreDisplay = document.getElementById('maliScore');
    const bonusDisplay = document.getElementById('maliBonus');
    const msgDisplay = document.getElementById('maliMsg');
    const winDisplay = document.getElementById('maliWinAmt');
    const startBtn = document.getElementById('maliStart');
    const doublePanel = document.getElementById('maliDouble');
    const doubleAmtDisplay = document.getElementById('maliDoubleAmt');
    const diceDisplay = document.getElementById('maliDice');
    const doubleMsgDisplay = document.getElementById('maliDoubleMsg');

    function showMsg(text) { msgDisplay.innerHTML = text; }
    function updateDisplay() {
        scoreDisplay.textContent = score;
        bonusDisplay.textContent = bonus;
    }

    function clearAllLights() {
        for (let i = 0; i < TOTAL_CELLS; i++) {
            document.getElementById('cell' + i).classList.remove('active', 'winner');
        }
    }

    function lightCell(idx) {
        clearAllLights();
        document.getElementById('cell' + idx).classList.add('active');
    }

    // ========== é–‹å§‹éŠæˆ² ==========
    startBtn.onclick = function() {
        if (isRunning) return;

        // å¦‚æœæ˜¯ã€Œå†ä¾†ä¸€æ¬¡ã€ï¼Œä¸éœ€è¦é‡æ–°æŠ¼æ³¨
        if (!pendingRetry) {
            const totalBet = Object.values(bets).reduce((a, b) => a + b, 0);
            if (totalBet === 0) { showMsg('è«‹å…ˆæŠ¼æ³¨ï¼'); return; }
            if (totalBet > score) { showMsg('åˆ†æ•¸ä¸è¶³ï¼'); return; }

            lastBets = { ...bets };
            score -= totalBet;
            bonus += Math.floor(totalBet * 0.05);
        } else {
            pendingRetry = false;
        }

        isRunning = true;
        updateDisplay();
        doublePanel.style.display = 'none';
        winDisplay.textContent = '';
        showMsg('è·‘ç‡ˆä¸­...');
        startBtn.disabled = true;

        runSpin();
    };

    function runSpin() {
        const weights = CELLS.map(fruit => FRUITS[fruit].weight);
        const totalWeight = weights.reduce((a, b) => a + b, 0);
        let rand = Math.random() * totalWeight;
        let stopPos = 0;
        for (let i = 0; i < weights.length; i++) {
            rand -= weights[i];
            if (rand <= 0) { stopPos = i; break; }
        }

        let pos = currentPos;
        let speed = 50;
        let rounds = 2 + Math.floor(Math.random() * 2);
        let totalSteps = rounds * TOTAL_CELLS + ((stopPos - currentPos + TOTAL_CELLS) % TOTAL_CELLS) + 1;
        let steps = 0;

        function runLight() {
            lightCell(pos);
            steps++;
            const progress = steps / totalSteps;
            if (progress > 0.7) speed = 50 + (progress - 0.7) * 1000;

            if (steps < totalSteps) {
                pos = (pos + 1) % TOTAL_CELLS;
                setTimeout(runLight, speed);
            } else {
                currentPos = pos;
                document.getElementById('cell' + pos).classList.add('winner');
                onStop(pos);
            }
        }
        setTimeout(runLight, speed);
    }

    function onStop(pos) {
        const fruitKey = CELLS[pos];
        const fruit = FRUITS[fruitKey];
        isRunning = false;
        startBtn.disabled = false;

        const betOnThis = bets[fruitKey] || 0;

        if (fruit.isRetry) {
            // ğŸ”„ å†ä¾†ä¸€æ¬¡
            showMsg('ğŸ”„ å†ä¾†ä¸€æ¬¡ï¼å…è²»å†è½‰ï¼');
            winDisplay.textContent = 'FREE';
            pendingRetry = true;
            setTimeout(() => {
                showMsg('æŒ‰ã€Œé–‹å§‹ã€å…è²»å†è½‰ï¼');
            }, 1000);
        } else if (fruit.isLose) {
            // ğŸ’€ æ²’æ”¶
            showMsg('ğŸ’€ æ²’æ”¶ï¼æœ¬å±€æ­¸é›¶');
            winDisplay.textContent = 'ğŸ˜­';
            winAmount = 0;
        } else if (fruit.isBonus) {
            // ğŸ° BONUS æ‹‰éœ¸
            showMsg('ğŸ° BONUSï¼');
            startSlotGame();
        } else if (betOnThis > 0) {
            winAmount = betOnThis * fruit.mult;
            score += winAmount;
            showMsg(`ä¸­ ${fruit.icon}ï¼`);
            winDisplay.textContent = '+' + winAmount;
            updateDisplay();
            showDoubleOption();
        } else {
            showMsg(`${fruit.icon} æ²’æŠ¼ä¸­`);
            winDisplay.textContent = '';
            winAmount = 0;
        }

        if (score < 10 && winAmount === 0 && !pendingRetry) {
            setTimeout(() => {
                if (confirm('åˆ†æ•¸ä¸è¶³ï¼è£œå…… 1000 åˆ†ï¼Ÿ')) {
                    score = 1000;
                    updateDisplay();
                    showMsg('å·²è£œå……ï¼');
                }
            }, 500);
        }
        updateDisplay();
    }

    // ========== BONUS æ‹‰éœ¸éŠæˆ² ==========
    function startSlotGame() {
        const overlay = document.getElementById('slotOverlay');
        const reels = [
            document.getElementById('slotReel0'),
            document.getElementById('slotReel1'),
            document.getElementById('slotReel2')
        ];
        const resultEl = document.getElementById('slotResult');
        const bonusAmtEl = document.getElementById('slotBonusAmt');
        const closeBtn = document.getElementById('slotClose');

        overlay.classList.add('active');
        closeBtn.style.display = 'none';
        resultEl.textContent = 'æ‹‰éœ¸ä¸­...';
        bonusAmtEl.textContent = '';

        // é–‹å§‹è½‰å‹•
        reels.forEach(r => {
            r.classList.add('spinning');
            r.classList.remove('winner');
        });

        // æ±ºå®šçµæœ
        const results = [];
        for (let i = 0; i < 3; i++) {
            results.push(SLOT_FRUITS[Math.floor(Math.random() * SLOT_FRUITS.length)]);
        }

        // ä¾åºåœæ­¢
        let stopIndex = 0;
        const stopTimes = [1000, 1800, 2600];

        function spinReel(reel) {
            const interval = setInterval(() => {
                reel.textContent = SLOT_FRUITS[Math.floor(Math.random() * SLOT_FRUITS.length)];
            }, 80);
            return interval;
        }

        const intervals = reels.map(r => spinReel(r));

        stopTimes.forEach((time, idx) => {
            setTimeout(() => {
                clearInterval(intervals[idx]);
                reels[idx].textContent = results[idx];
                reels[idx].classList.remove('spinning');
            }, time);
        });

        // çµç®—
        setTimeout(() => {
            let slotWin = bonus; // åŸºæœ¬å½©é‡‘
            let multiplier = 1;
            let matchMsg = '';

            // æª¢æŸ¥é€£ç·š
            if (results[0] === results[1] && results[1] === results[2]) {
                // ä¸‰é€£ç·šï¼
                multiplier = 3;
                matchMsg = `ğŸ‰ ä¸‰é€£ç·š ${results[0]}ï¼`;
                reels.forEach(r => r.classList.add('winner'));
            } else if (results[0] === results[1] || results[1] === results[2] || results[0] === results[2]) {
                // å…©é€£ç·š
                multiplier = 1.5;
                matchMsg = 'âœ¨ å…©é€£ç·šï¼';
                if (results[0] === results[1]) { reels[0].classList.add('winner'); reels[1].classList.add('winner'); }
                if (results[1] === results[2]) { reels[1].classList.add('winner'); reels[2].classList.add('winner'); }
                if (results[0] === results[2]) { reels[0].classList.add('winner'); reels[2].classList.add('winner'); }
            } else {
                matchMsg = 'åŸºæœ¬å½©é‡‘';
            }

            slotWin = Math.floor(bonus * multiplier);
            score += slotWin;
            winAmount = slotWin;
            bonus = 100; // é‡ç½®å½©é‡‘æ± 

            resultEl.innerHTML = matchMsg + `<br>x${multiplier}`;
            bonusAmtEl.textContent = '+' + slotWin;
            closeBtn.style.display = 'inline-block';
            updateDisplay();
        }, 3000);
    }

    document.getElementById('slotClose').onclick = function() {
        document.getElementById('slotOverlay').classList.remove('active');
        winDisplay.textContent = '+' + winAmount;
        showDoubleOption();
    };

    // ========== æ¯”å¤§å° ==========
    function showDoubleOption() {
        if (winAmount > 0) {
            doublePanel.style.display = 'block';
            doubleAmtDisplay.textContent = winAmount;
            diceDisplay.textContent = '';
            doubleMsgDisplay.textContent = 'çŒœå°ç¿»å€ï¼';
        }
    }

    document.getElementById('maliBig').onclick = () => doDouble('big');
    document.getElementById('maliSmall').onclick = () => doDouble('small');
    document.getElementById('maliTake').onclick = takeWin;

    function doDouble(choice) {
        const dice = Math.floor(Math.random() * 13) + 1;
        const diceEmojis = ['', '1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ğŸ”Ÿ', 'â“«', 'â“¬', 'â“­'];

        let rollCount = 0;
        const rollInterval = setInterval(() => {
            diceDisplay.textContent = diceEmojis[Math.floor(Math.random() * 13) + 1];
            rollCount++;
            if (rollCount >= 10) {
                clearInterval(rollInterval);
                diceDisplay.textContent = diceEmojis[dice];

                const isSmall = dice >= 1 && dice <= 6;
                const isBig = dice >= 8 && dice <= 13;
                const isTie = dice === 7;

                if (isTie) {
                    doubleMsgDisplay.innerHTML = '<span style="color:#ffff00;">é–‹7ï¼å¹³æ‰‹</span>';
                } else if ((choice === 'big' && isBig) || (choice === 'small' && isSmall)) {
                    winAmount *= 2;
                    score += winAmount / 2;
                    doubleAmtDisplay.textContent = winAmount;
                    doubleMsgDisplay.innerHTML = `<span style="color:#00ff00;">ğŸ‰ ç¿»å€ ${winAmount}ï¼</span>`;
                    updateDisplay();
                } else {
                    score -= winAmount;
                    doubleMsgDisplay.innerHTML = `<span style="color:#ff0000;">ğŸ’” è¼¸äº†ï¼</span>`;
                    winAmount = 0;
                    updateDisplay();
                    setTimeout(() => { doublePanel.style.display = 'none'; }, 1500);
                }
                if (winAmount > 0) doubleAmtDisplay.textContent = winAmount;
            }
        }, 80);
    }

    function takeWin() {
        doubleMsgDisplay.innerHTML = `<span style="color:#00ff00;">æ”¶ä¸‹ ${winAmount}ï¼</span>`;
        winAmount = 0;
        setTimeout(() => { doublePanel.style.display = 'none'; }, 800);
    }

    // ========== åˆå§‹åŒ– ==========
    initBetPanel();
    updateDisplay();
})();
</script>

</body>
</html>
